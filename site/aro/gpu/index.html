
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation from the MOBB/MOST Team">
      
      
        <meta name="author" content="The MOBB Team">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="docums-, docurial-8.1.8">
    
    
      
        <title>ARO for GPU Workloads - MOBB Ninja</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6e60f8b8.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#aro-with-nvidia-gpu-workloads" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MOBB Ninja" class="md-header__button md-logo" aria-label="MOBB Ninja" data-md-component="logo">
      
  <img src="../../assets/avatar.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MOBB Ninja
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ARO for GPU Workloads
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to Dark Mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to Dark Mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="" data-md-color-accent=""  aria-label="Switch to Light Mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to Light Mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/rh-mobb/documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../private-cluster/" class="md-tabs__link md-tabs__link--active">
        Products
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../quickstart-aro/" class="md-tabs__link">
        Quickstarts
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../acm/observability/rosa/" class="md-tabs__link">
        Advanced Cluster Manager (ACM)
      </a>
    </li>
  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../rosa/custom-alertmanager-4.9/" class="md-tabs__link">
        Observability
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../security/secrets-store-csi/hashicorp-vault/" class="md-tabs__link">
        Security
      </a>
    </li>
  

  

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../blog/" class="md-tabs__link">
      Blogs
    </a>
  </li>

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MOBB Ninja" class="md-nav__button md-logo" aria-label="MOBB Ninja" data-md-component="logo">
      
  <img src="../../assets/avatar.png" alt="logo">

    </a>
    MOBB Ninja
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/rh-mobb/documentation" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Products
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Products" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Products
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          ARO
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ARO" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          ARO
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../private-cluster/" class="md-nav__link">
        Private Cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ocm/" class="md-nav__link">
        Openshift Cluster Manager (OCM)
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ARO for GPU Workloads
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        ARO for GPU Workloads
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm-prerequisites" class="md-nav__link">
    Helm Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu-quota" class="md-nav__link">
    GPU Quota
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-in-to-your-aro-cluster" class="md-nav__link">
    Log in to your ARO cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pull-secret-conditional" class="md-nav__link">
    Pull secret (Conditional)
  </a>
  
    <nav class="md-nav" aria-label="Pull secret (Conditional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-helm" class="md-nav__link">
    Using Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually" class="md-nav__link">
    Manually
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu-machine-set" class="md-nav__link">
    GPU Machine Set
  </a>
  
    <nav class="md-nav" aria-label="GPU Machine Set">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm" class="md-nav__link">
    Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually_1" class="md-nav__link">
    Manually
  </a>
  
    <nav class="md-nav" aria-label="Manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-gpu-machine-set" class="md-nav__link">
    Create GPU machine set
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-nvidia-gpu-operator" class="md-nav__link">
    Install Nvidia GPU Operator
  </a>
  
    <nav class="md-nav" aria-label="Install Nvidia GPU Operator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm_1" class="md-nav__link">
    Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually_2" class="md-nav__link">
    Manually
  </a>
  
    <nav class="md-nav" aria-label="Manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-node-feature-discovery-operator" class="md-nav__link">
    Install Node Feature Discovery Operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-nvidia-cluster-config" class="md-nav__link">
    Apply nVidia Cluster Config
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-gpu" class="md-nav__link">
    Validate GPU
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../frontdoor/" class="md-nav__link">
        Azure Frontdoor
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1_5" type="checkbox" id="__nav_2_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1_5">
          Azure Service Operator
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Azure Service Operator" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_1_5">
          <span class="md-nav__icon md-icon"></span>
          Azure Service Operator
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../azure-service-operator-v1/" class="md-nav__link">
        v1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../azure-service-operator-v2/" class="md-nav__link">
        v2
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          ROSA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ROSA" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          ROSA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/private-link/" class="md-nav__link">
        Private Link
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_2" type="checkbox" id="__nav_2_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2_2">
          Secure Token Service (STS)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Secure Token Service (STS)" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_2">
          <span class="md-nav__icon md-icon"></span>
          Secure Token Service (STS)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/sts/" class="md-nav__link">
        Create ROSA Cluster w/STS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          GCP
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="GCP" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          GCP
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gcp/osd_preexisting_vpc/" class="md-nav__link">
        Deploy OSD in GCP w/ BYO VPC
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../gcp/filestore/" class="md-nav__link">
        Using Filestore w/ OSD
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Quickstarts
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Quickstarts" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Quickstarts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart-aro/" class="md-nav__link">
        ARO Quickstart
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart-rosa/" class="md-nav__link">
        ROSA Quickstart
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Advanced Cluster Manager (ACM)
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced Cluster Manager (ACM)" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Advanced Cluster Manager (ACM)
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../acm/observability/rosa/" class="md-nav__link">
        Deploy ACM Observability to a ROSA Cluster
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Observability
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Observability" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Observability
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5_1" type="checkbox" id="__nav_5_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5_1">
          Configuring Alerts for User Workloads
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Configuring Alerts for User Workloads" data-md-level="2">
        <label class="md-nav__title" for="__nav_5_1">
          <span class="md-nav__icon md-icon"></span>
          Configuring Alerts for User Workloads
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/custom-alertmanager-4.9/" class="md-nav__link">
        ROSA 4.9.X
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/custom-alertmanager/" class="md-nav__link">
        ROSA 4.11+
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/federated-metrics/" class="md-nav__link">
        Federating ROSA Metrics to S3
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Security" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_1" type="checkbox" id="__nav_6_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_1">
          K8s Secret Store CSI Driver
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="K8s Secret Store CSI Driver" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_1">
          <span class="md-nav__icon md-icon"></span>
          K8s Secret Store CSI Driver
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/secrets-store-csi/hashicorp-vault/" class="md-nav__link">
        HashiCorp CSI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../rosa/aws-secrets-manager-csi/" class="md-nav__link">
        AWS Secrets CSI w/ ROSA STS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/secrets-store-csi/azure-key-vault/" class="md-nav__link">
        Azure Key Vault CSI Driver
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2" type="checkbox" id="__nav_6_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2">
          Configuring IDPs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Configuring IDPs" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_2">
          <span class="md-nav__icon md-icon"></span>
          Configuring IDPs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_1" type="checkbox" id="__nav_6_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_1">
          Azure AD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Azure AD" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_1">
          <span class="md-nav__icon md-icon"></span>
          Azure AD
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/azuread-aro/" class="md-nav__link">
        Azure AD for ARO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/group-claims/aro/" class="md-nav__link">
        Azure AD for ARO w/group claims
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/group-claims/rosa/" class="md-nav__link">
        Azure AD for ROSA w/group claims
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/azuread/" class="md-nav__link">
        Azure AD for ROSA/OSD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/azuread-aro-cli/" class="md-nav__link">
        Azure AD for ARO via CLI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_2_2" type="checkbox" id="__nav_6_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_2_2">
          Gitlab
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Gitlab" data-md-level="3">
        <label class="md-nav__title" for="__nav_6_2_2">
          <span class="md-nav__icon md-icon"></span>
          Gitlab
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/gitlab/" class="md-nav__link">
        ROSA/OSD
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../idp/gitlab-aro/" class="md-nav__link">
        ARO
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_3" type="checkbox" id="__nav_6_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6_3">
          Advanced Cluster Security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Advanced Cluster Security" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_3">
          <span class="md-nav__icon md-icon"></span>
          Advanced Cluster Security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../security/rhacs/" class="md-nav__link">
        Deploying ACS in ROSA/ARO
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../blog/" class="md-nav__link">
        Blogs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm-prerequisites" class="md-nav__link">
    Helm Prerequisites
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu-quota" class="md-nav__link">
    GPU Quota
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#log-in-to-your-aro-cluster" class="md-nav__link">
    Log in to your ARO cluster
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pull-secret-conditional" class="md-nav__link">
    Pull secret (Conditional)
  </a>
  
    <nav class="md-nav" aria-label="Pull secret (Conditional)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-helm" class="md-nav__link">
    Using Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually" class="md-nav__link">
    Manually
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu-machine-set" class="md-nav__link">
    GPU Machine Set
  </a>
  
    <nav class="md-nav" aria-label="GPU Machine Set">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm" class="md-nav__link">
    Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually_1" class="md-nav__link">
    Manually
  </a>
  
    <nav class="md-nav" aria-label="Manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-gpu-machine-set" class="md-nav__link">
    Create GPU machine set
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#install-nvidia-gpu-operator" class="md-nav__link">
    Install Nvidia GPU Operator
  </a>
  
    <nav class="md-nav" aria-label="Install Nvidia GPU Operator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#helm_1" class="md-nav__link">
    Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#manually_2" class="md-nav__link">
    Manually
  </a>
  
    <nav class="md-nav" aria-label="Manually">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-node-feature-discovery-operator" class="md-nav__link">
    Install Node Feature Discovery Operator
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apply-nvidia-cluster-config" class="md-nav__link">
    Apply nVidia Cluster Config
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-gpu" class="md-nav__link">
    Validate GPU
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
<a href="https://github.com/rh-mobb/documentation/edit/master/docs/aro/gpu/README.md" title="Edit this page" class="md-content__button md-icon">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
</a>


<h1 id="aro-with-nvidia-gpu-workloads">ARO with Nvidia GPU Workloads</h1>
<p>ARO guide to running Nvidia GPU workloads.</p>
<p>Author: <a href="https://twitter.com/byron_miller">Byron Miller</a>, <a href="https://github.com/redhatstuart">Stuart Kirk</a></p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li>Do not remove this line (it will not be displayed)
{:toc}</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<ul>
<li>oc cli</li>
<li>jq, moreutils, and gettext package</li>
<li>ARO 4.10</li>
</ul>
<p>If you need to install an ARO cluster, please read our <a href="https://mobb.ninja/docs/quickstart-aro.html">ARO Quick start guide</a>. Please be sure if you're installing or using an existing ARO cluster that it is 4.10.x or higher.</p>
<blockquote>
<p>As of OpenShift 4.10, it is no longer necessary to set up entitlements to use the nVidia Operator. This has greatly simplified the setup of the cluster for GPU workloads.</p>
</blockquote>
<p>Linux:</p>
<pre><code class="language-bash">sudo dnf install jq moreutils gettext
</code></pre>
<p>MacOS</p>
<pre><code class="language-bash">brew install jq moreutils gettext
</code></pre>
<h3 id="helm-prerequisites">Helm Prerequisites</h3>
<p>If you plan to use Helm to deploy the GPU operator, you will need do the following</p>
<ol>
<li>
<p>Add the MOBB chart repository to your Helm</p>
<p><code>bash
helm repo add mobb https://rh-mobb.github.io/helm-charts/</code></p>
</li>
<li>
<p>Update your repositories</p>
<p><code>bash
helm repo update</code></p>
</li>
</ol>
<h2 id="gpu-quota">GPU Quota</h2>
<p>All GPU quotas in Azure are 0 by default. You will need to login to the azure portal and request GPU quota. There is a lot of competition for GPU workers, so you may have to provision an ARO cluster in a region where you can actually reserve GPU.
ARO supports the following GPU workers:
* NC4as T4 v3
* NC8as T4 v3
* NC16as T4 v3
* NC464as T4 v3</p>
<blockquote>
<p>Please remember that when you request quota that Azure is per core.  To request a single NC4as T4 v3 node, you will need to request quota in groups of 4. If you wish to request an NC16as T4 v3 you will need to request quota of 16.</p>
</blockquote>
<ol>
<li>Login to azure</li>
</ol>
<p>Login to <a href="https://portal.azure.com">portal.azure.com</a>, type "quotas" in search by, click on Compute and in the search box type "NCAsv3_T4". Select the region your cluster is in (select checkbox) and then click Request quota increase and ask for quota (I chose 8 so i can build two demo clusters of NC4as T4s).</p>
<ol>
<li>Configure quota</li>
</ol>
<p><img alt="GPU Quota Request on Azure" src="gpu-quota-azure.png" /></p>
<h2 id="log-in-to-your-aro-cluster">Log in to your ARO cluster</h2>
<ol>
<li>Login to OpenShift - we'll use the kubeadmin account here but you can login with your user account as long as you have cluster-admin.</li>
</ol>
<p><code>bash
   oc login &lt;apiserver&gt; -u kubeadmin -p &lt;kubeadminpass&gt;</code></p>
<h2 id="pull-secret-conditional">Pull secret (Conditional)</h2>
<p>We'll update our pull secret to make sure that we can install operators as well as connect to cloud.redhat.com.</p>
<blockquote>
<p>If you have already re-created a full pull secret with cloud.redhat.com enabled you can skip this step</p>
</blockquote>
<h3 id="using-helm">Using Helm</h3>
<ol>
<li>Before Deploying the chart you need it to adopt the existing pull secret</li>
</ol>
<p><code>bash
   kubectl -n openshift-config annotate secret \
    pull-secret meta.helm.sh/release-name=pull-secret
   kubectl -n openshift-config annotate secret \
     pull-secret meta.helm.sh/release-namespace=openshift-config
   kubectl -n openshift-config label secret \
     pull-secret app.kubernetes.io/managed-by=Helm</code></p>
<ol>
<li>
<p>Download your new pull secret from <strong>https://console.redhat.com/openshift/downloads -&gt; Tokens -&gt; Pull secret</strong> and use it to update create the pull secret in your cluster.</p>
</li>
<li>
<p>Update the pull secret</p>
</li>
</ol>
<blockquote>
<p>This chart will merge the in-cluster pull secret with the new pull secret.</p>
</blockquote>
<p><code>helm upgrade --install pull-secret mobb/aro-pull-secret \
     -n openshift-config --set-file pullSecret=$HOME/Downloads/pull-secret.txt</code></p>
<ol>
<li>Enable Operator Hub</li>
</ol>
<p><code>bash
   oc patch configs.samples.operator.openshift.io cluster --type=merge \
         -p='{"spec":{"managementState":"Managed"}}'
   oc patch operatorhub cluster --type=merge \
         -p='{"spec":{"sources":[
           {"name":"redhat-operators","disabled":false},
           {"name":"certified-operators","disabled":false},
           {"name":"community-operators","disabled":false},
           {"name":"redhat-marketplace","disabled":false}
         ]}}'</code></p>
<ol>
<li>Skip to <a href="#gpu-machine-set">GPU Machine Set</a></li>
</ol>
<h3 id="manually">Manually</h3>
<ol>
<li>
<p>Log into <a href="https://cloud.redhat.com">cloud.redhat.com</a></p>
</li>
<li>
<p>Browse to https://cloud.redhat.com/openshift/install/azure/aro-provisioned</p>
</li>
<li>
<p>click the <strong>Download pull secret</strong> button and save it as pull-secret.txt</p>
</li>
</ol>
<blockquote>
<p>The following steps will need to be ran in the same working directory as your pull-secret.txt</p>
</blockquote>
<ol>
<li>Export existing pull secret</li>
</ol>
<p><code>bash
   oc get secret pull-secret -n openshift-config -o json | jq -r '.data.".dockerconfigjson"' | base64 --decode &gt; export-pull.json</code></p>
<ol>
<li>Merge downloaded pull secret with system pull secret to add cloud.redhat.com</li>
</ol>
<p><code>bash
   jq -s '.[0] * .[1]' export-pull.json pull-secret.txt | tr -d "\n\r" &gt; new-pull-secret.json</code></p>
<ol>
<li>Upload new secret file</li>
</ol>
<p><code>bash
   oc set data secret/pull-secret -n openshift-config --from-file=.dockerconfigjson=new-pull-secret.json</code></p>
<blockquote>
<p>You may need to wait for about ~1hr for everything to sync up with cloud.redhat.com.</p>
</blockquote>
<ol>
<li>Delete secrets</li>
</ol>
<p><code>bash
   rm pull-secret.txt export-pull.json new-pull-secret.json</code></p>
<h2 id="gpu-machine-set">GPU Machine Set</h2>
<p>ARO still uses Kubernetes Machinsets to create a machine set.  I'm going to export the first machine set in my cluster (az 1) and use that as a template to build a single GPU machine in southcentralus region 1.</p>
<h3 id="helm">Helm</h3>
<ol>
<li>Create a new machine-set (replicas of 1), see the Chart's <a href="https://github.com/rh-mobb/helm-charts/blob/main/charts/aro-gpu/values.yaml">values</a> file for configuration options</li>
</ol>
<p><code>helm upgrade --install -n openshift-machine-api \
      gpu mobb/aro-gpu</code></p>
<ol>
<li>Wait for the new GPU nodes to be available</li>
</ol>
<p><code>bash
   watch oc get machines</code></p>
<ol>
<li>Skip to <a href="#install-nvidia-gpu-operator">Install Nvidia GPU Operator</a></li>
</ol>
<h3 id="manually_1">Manually</h3>
<ol>
<li>View existing machine sets</li>
</ol>
<blockquote>
<p>For ease of set up, I'm going to grab the first machine set and use that as the one I will clone to create our GPU machine set.</p>
</blockquote>
<p><code>bash
   MACHINESET=$(oc get machineset -n openshift-machine-api -o=jsonpath='{.items[0]}' | jq -r '[.metadata.name] | @tsv')</code></p>
<ol>
<li>Save a copy of example machine set</li>
</ol>
<p><code>bash
   oc get machineset -n openshift-machine-api $MACHINESET -o json &gt; gpu_machineset.json</code></p>
<ol>
<li>Change the .metadata.name field to a new unique name</li>
</ol>
<blockquote>
<p>I'm going to create a unique name for this single node machine set that shows nvidia-worker-<region><az> that follows a similar pattern as all the other machine sets.</p>
</blockquote>
<p><code>bash
   jq '.metadata.name = "nvidia-worker-southcentralus1"' gpu_machineset.json| sponge gpu_machineset.json</code></p>
<ol>
<li>
<p>Ensure spec.replicas matches the desired replica count for the MachineSet</p>
<p><code>bash
jq '.spec.replicas = 1' gpu_machineset.json| sponge gpu_machineset.json</code></p>
</li>
<li>
<p>Change the .spec.selector.matchLabels.machine.openshift.io/cluster-api-machineset field to match the .metadata.name field</p>
</li>
</ol>
<p><code>bash
   jq '.spec.selector.matchLabels."machine.openshift.io/cluster-api-machineset" = "nvidia-worker-southcentralus1"' gpu_machineset.json| sponge gpu_machineset.json</code></p>
<ol>
<li>Change the .spec.template.metadata.labels.machine.openshift.io/cluster-api-machineset to match the .metadata.name field</li>
</ol>
<p><code>bash
   jq '.spec.template.metadata.labels."machine.openshift.io/cluster-api-machineset" = "nvidia-worker-southcentralus1"' gpu_machineset.json| sponge gpu_machineset.json</code></p>
<ol>
<li>Change the spec.template.spec.providerSpec.value.vmSize to match the desired GPU instance type from Azure.</li>
</ol>
<blockquote>
<p>The machine we're using is Standard_NC4as_T4_v3.</p>
</blockquote>
<p><code>bash
   jq '.spec.template.spec.providerSpec.value.vmSize = "Standard_NC4as_T4_v3"' gpu_machineset.json | sponge gpu_machineset.json</code></p>
<ol>
<li>
<p>Change the spec.template.spec.providerSpec.value.zone to match the desired zone from Azure</p>
<p><code>bash
jq '.spec.template.spec.providerSpec.value.zone = "1"' gpu_machineset.json | sponge gpu_machineset.json</code></p>
</li>
<li>
<p>Delete the .status section of the yaml file</p>
</li>
</ol>
<p><code>bash
   jq 'del(.status)' gpu_machineset.json | sponge gpu_machineset.json</code></p>
<ol>
<li>Verify the other data in the yaml file.</li>
</ol>
<h4 id="create-gpu-machine-set">Create GPU machine set</h4>
<p>These steps will create the new GPU machine. It may take 10-15 minutes to provision a new GPU machine. If this step fails, please login to the <a href="https://portal.azure.com">azure portal</a> and ensure you didn't run across availability issues. You can go "Virtual Machines" and search for the worker name you created above to see the status of VMs.</p>
<ol>
<li>Create GPU Machine set</li>
</ol>
<p><code>bash
   oc create -f gpu_machineset.json</code></p>
<blockquote>
<p>This command will take a few minutes to complete.</p>
</blockquote>
<ol>
<li>Verify GPU machine set</li>
</ol>
<p>Machines should be getting deployed. You can view the status of the machine set with the following commands</p>
<p><code>bash
   oc get machineset -n openshift-machine-api
   oc get machine -n openshift-machine-api</code></p>
<p>Once the machines are provisioned, which could take 5-15 minutes, machines will show as nodes in the node list.</p>
<p><code>bash
   oc get nodes</code></p>
<p>You should see a node with the "nvidia-worker-southcentralus1" name it we created earlier.</p>
<h2 id="install-nvidia-gpu-operator">Install Nvidia GPU Operator</h2>
<p>This will create the nvidia-gpu-operator name space, set up the operator group and install the Nvidia GPU Operator.</p>
<h3 id="helm_1">Helm</h3>
<ol>
<li>
<p>Create namespaces</p>
<p><code>bash
oc create namespace openshift-nfd
oc create namespace nvidia-gpu-operator</code></p>
</li>
<li>
<p>Use the <code>mobb/operatorhub</code> chart to deploy the needed operators</p>
<p><code>bash
helm upgrade -n nvidia-gpu-operator nvidia-gpu-operator \
  mobb/operatorhub --install \
  --values https://raw.githubusercontent.com/rh-mobb/helm-charts/main/charts/nvidia-gpu/files/operatorhub.yaml</code></p>
</li>
<li>
<p>Wait until the two operators are running</p>
<p><code>bash
watch kubectl get pods -n openshift-nfd</code></p>
<p><code>NAME                                      READY   STATUS    RESTARTS   AGE
nfd-controller-manager-7b66c67bd9-rk98w   2/2     Running   0          47s</code></p>
<p><code>bash
watch oc get pods -n nvidia-gpu-operator</code></p>
<p><code>NAME                            READY   STATUS    RESTARTS   AGE
gpu-operator-5d8cb7dd5f-c4ljk   1/1     Running   0          87s</code></p>
</li>
<li>
<p>Install the Nvidia GPU Operator chart</p>
<p>```bash</p>
<p><code>bash
helm upgrade --install -n nvidia-gpu-operator nvidia-gpu \
  mobb/nvidia-gpu --disable-openapi-validation</code></p>
</li>
<li>
<p>Skip to <a href="#validate-gpu">Validate GPU</a></p>
</li>
</ol>
<h3 id="manually_2">Manually</h3>
<ol>
<li>Create Nvidia namespace</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: v1
   kind: Namespace
   metadata:
     name: nvidia-gpu-operator
   EOF</code></p>
<ol>
<li>Create Operator Group</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: operators.coreos.com/v1
   kind: OperatorGroup
   metadata:
     name: nvidia-gpu-operator-group
     namespace: nvidia-gpu-operator
   spec:
    targetNamespaces:
    - nvidia-gpu-operator
   EOF</code></p>
<ol>
<li>Get latest nvidia channel</li>
</ol>
<p><code>bash
   CHANNEL=$(oc get packagemanifest gpu-operator-certified -n openshift-marketplace -o jsonpath='{.status.defaultChannel}')</code></p>
<ol>
<li>Get latest nvidia package</li>
</ol>
<p><code>bash
   PACKAGE=$(oc get packagemanifests/gpu-operator-certified -n openshift-marketplace -ojson | jq -r '.status.channels[] | select(.name == "'$CHANNEL'") | .currentCSV')</code></p>
<ol>
<li>Create Subscription</li>
</ol>
<p><code>yaml
   envsubst  &lt;&lt;EOF | oc apply -f -
   apiVersion: operators.coreos.com/v1alpha1
   kind: Subscription
   metadata:
     name: gpu-operator-certified
     namespace: nvidia-gpu-operator
   spec:
     channel: "$CHANNEL"
     installPlanApproval: Automatic
     name: gpu-operator-certified
     source: certified-operators
     sourceNamespace: openshift-marketplace
     startingCSV: "$PACKAGE"
   EOF</code></p>
<ol>
<li>Wait for Operator to finish installing</li>
</ol>
<blockquote>
<p>Don't proceed until you have verified that the operator has finished installing. It's also a good point to ensure that your GPU worker is online.</p>
</blockquote>
<p><img alt="Verify Operator" src="nvidia-installed.png" /></p>
<h4 id="install-node-feature-discovery-operator">Install Node Feature Discovery Operator</h4>
<p>The node feature discovery operator will discover the GPU on your nodes and appropriately label the nodes so you can target them for workloads.  We'll install the NFD operator into the opneshift-ndf namespace and create the "subscription" which is the configuration for NFD.</p>
<p>Official Documentation for Installing <a href="https://docs.openshift.com/container-platform/4.10/hardware_enablement/psap-node-feature-discovery-operator.html">Node Feature Discovery Operator</a></p>
<ol>
<li>Set up Name Space</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: v1
   kind: Namespace
   metadata:
     name: openshift-nfd
   EOF</code></p>
<ol>
<li>Create OperatorGroup</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: operators.coreos.com/v1
   kind: OperatorGroup
   metadata:
     generateName: openshift-nfd-
     name: openshift-nfd
     namespace: openshift-nfd
   EOF</code></p>
<ol>
<li>Create Subscription</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: operators.coreos.com/v1alpha1
   kind: Subscription
   metadata:
     name: nfd
     namespace: openshift-nfd
   spec:
     channel: "stable"
     installPlanApproval: Automatic
     name: nfd
     source: redhat-operators
     sourceNamespace: openshift-marketplace
   EOF</code>
1. Wait for Node Feature discovery to complete installation</p>
<p>You can login to your openshift console and view operators or simply wait a few minutes. The next step will error until the operator has finished installing.</p>
<ol>
<li>Create NFD Instance</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   kind: NodeFeatureDiscovery
   apiVersion: nfd.openshift.io/v1
   metadata:
     name: nfd-instance
     namespace: openshift-nfd
   spec:
     customConfig:
       configData: |
         #    - name: "more.kernel.features"
         #      matchOn:
         #      - loadedKMod: ["example_kmod3"]
         #    - name: "more.features.by.nodename"
         #      value: customValue
         #      matchOn:
         #      - nodename: ["special-.*-node-.*"]
     operand:
       image: &gt;-
         registry.redhat.io/openshift4/ose-node-feature-discovery@sha256:07658ef3df4b264b02396e67af813a52ba416b47ab6e1d2d08025a350ccd2b7b
       servicePort: 12000
     workerConfig:
       configData: |
         core:
         #  labelWhiteList:
         #  noPublish: false
           sleepInterval: 60s
         #  sources: [all]
         #  klog:
         #    addDirHeader: false
         #    alsologtostderr: false
         #    logBacktraceAt:
         #    logtostderr: true
         #    skipHeaders: false
         #    stderrthreshold: 2
         #    v: 0
         #    vmodule:
         ##   NOTE: the following options are not dynamically run-time
         ##          configurable and require a nfd-worker restart to take effect
         ##          after being changed
         #    logDir:
         #    logFile:
         #    logFileMaxSize: 1800
         #    skipLogHeaders: false
         sources:
         #  cpu:
         #    cpuid:
         ##     NOTE: whitelist has priority over blacklist
         #      attributeBlacklist:
         #        - "BMI1"
         #        - "BMI2"
         #        - "CLMUL"
         #        - "CMOV"
         #        - "CX16"
         #        - "ERMS"
         #        - "F16C"
         #        - "HTT"
         #        - "LZCNT"
         #        - "MMX"
         #        - "MMXEXT"
         #        - "NX"
         #        - "POPCNT"
         #        - "RDRAND"
         #        - "RDSEED"
         #        - "RDTSCP"
         #        - "SGX"
         #        - "SSE"
         #        - "SSE2"
         #        - "SSE3"
         #        - "SSE4.1"
         #        - "SSE4.2"
         #        - "SSSE3"
         #      attributeWhitelist:
         #  kernel:
         #    kconfigFile: "/path/to/kconfig"
         #    configOpts:
         #      - "NO_HZ"
         #      - "X86"
         #      - "DMI"
           pci:
             deviceClassWhitelist:
               - "0200"
               - "03"
               - "12"
             deviceLabelFields:
         #      - "class"
               - "vendor"
         #      - "device"
         #      - "subsystem_vendor"
         #      - "subsystem_device"
         #  usb:
         #    deviceClassWhitelist:
         #      - "0e"
         #      - "ef"
         #      - "fe"
         #      - "ff"
         #    deviceLabelFields:
         #      - "class"
         #      - "vendor"
         #      - "device"
         #  custom:
         #    - name: "my.kernel.feature"
         #      matchOn:
         #        - loadedKMod: ["example_kmod1", "example_kmod2"]
         #    - name: "my.pci.feature"
         #      matchOn:
         #        - pciId:
         #            class: ["0200"]
         #            vendor: ["15b3"]
         #            device: ["1014", "1017"]
         #        - pciId :
         #            vendor: ["8086"]
         #            device: ["1000", "1100"]
         #    - name: "my.usb.feature"
         #      matchOn:
         #        - usbId:
         #          class: ["ff"]
         #          vendor: ["03e7"]
         #          device: ["2485"]
         #        - usbId:
         #          class: ["fe"]
         #          vendor: ["1a6e"]
         #          device: ["089a"]
         #    - name: "my.combined.feature"
         #      matchOn:
         #        - pciId:
         #            vendor: ["15b3"]
         #            device: ["1014", "1017"]
         #          loadedKMod : ["vendor_kmod1", "vendor_kmod2"]
   EOF</code></p>
<ol>
<li>Verify NFD is ready.</li>
</ol>
<p>This operator should say Available in the status</p>
<p><img alt="NFD Operator Ready" src="nfd-ready-for-use.png" /></p>
<h4 id="apply-nvidia-cluster-config">Apply nVidia Cluster Config</h4>
<p>We'll now apply the nvidia cluster config. Please read the <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/openshift/install-gpu-ocp.html">nvidia documentation</a> on customizing this if you have your own private repos or specific settings. This will be another process that takes a few minutes to complete.</p>
<ol>
<li>Apply cluster config</li>
</ol>
<p><code>yaml
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: nvidia.com/v1
   kind: ClusterPolicy
   metadata:
     name: gpu-cluster-policy
   spec:
     migManager:
       enabled: true
     operator:
       defaultRuntime: crio
       initContainer: {}
       runtimeClass: nvidia
       deployGFD: true
     dcgm:
       enabled: true
     gfd: {}
     dcgmExporter:
       config:
         name: ''
     driver:
       licensingConfig:
         nlsEnabled: false
         configMapName: ''
       certConfig:
         name: ''
       kernelModuleConfig:
         name: ''
       repoConfig:
         configMapName: ''
       virtualTopology:
         config: ''
       enabled: true
       use_ocp_driver_toolkit: true
     devicePlugin: {}
     mig:
       strategy: single
     validator:
       plugin:
         env:
           - name: WITH_WORKLOAD
             value: 'true'
     nodeStatusExporter:
       enabled: true
     daemonsets: {}
     toolkit:
       enabled: true
   EOF</code></p>
<ol>
<li>Verify Cluster Policy</li>
</ol>
<p>Login to OpenShift console and browse to operators and make sure you're in nvidia-gpu-operator namespace. You should see it say State: Ready once everything is complete.</p>
<p><img alt="cluster policy" src="nvidia-cluster-policy.png" /></p>
<h2 id="validate-gpu">Validate GPU</h2>
<p>It may take some time for the nVidia Operator and NFD to completely install and self-identify the machines. These commands can be ran to help validate that everything is running as expected.</p>
<ol>
<li>
<p>Verify NFD can see your GPU(s)</p>
<p><code>bash
oc describe node | egrep 'Roles|pci-10de' | grep -v master</code></p>
<p>You should see output like:</p>
<p><code>bash
Roles:              worker
                feature.node.kubernetes.io/pci-10de.present=true</code></p>
</li>
<li>
<p>Verify node labels</p>
</li>
</ol>
<p>You can see the node labels by logging into the OpenShift console -&gt; Compute -&gt; Nodes -&gt; nvidia-worker-southcentralus1-<id>.  You should see a bunch of nvidia GPU labels and the pci-10de device from above.</p>
<p><img alt="NFD Node labels" src="node-labels.png" /></p>
<ol>
<li>Nvidia SMI tool verification</li>
</ol>
<p><code>bash
   oc project nvidia-gpu-operator
   for i in $(oc get pod -lopenshift.driver-toolkit=true --no-headers |awk '{print $1}'); do echo $i; oc exec -it $i -- nvidia-smi ; echo -e '\n' ;  done</code></p>
<p>You should see output that shows the GPUs available on the host such as this example screenshot. (Varies depending on GPU worker type)</p>
<p><img alt="Nvidia SMI" src="test-gpu.png" /></p>
<ol>
<li>Create Pod to run a GPU workload</li>
</ol>
<p><code>yaml
   oc project nvidia-gpu-operator
   cat &lt;&lt;EOF | oc apply -f -
   apiVersion: v1
   kind: Pod
   metadata:
     name: cuda-vector-add
   spec:
     restartPolicy: OnFailure
     containers:
       - name: cuda-vector-add
         image: "quay.io/giantswarm/nvidia-gpu-demo:latest"
         resources:
           limits:
             nvidia.com/gpu: 1
         nodeSelector:
           nvidia.com/gpu.present: true
   EOF</code></p>
<ol>
<li>View logs</li>
</ol>
<p><code>bash
   oc logs cuda-vector-add --tail=-1</code></p>
<blockquote>
<p>Please note, if you get an error "Error from server (BadRequest): container "cuda-vector-add" in pod "cuda-vector-add" is waiting to start: ContainerCreating" try running "oc delete pod cuda-vector-add" and then re-run the create statement above. I've seen issues where if this step is ran before all of the operator consolidation is done it may just sit there.</p>
</blockquote>
<p>You should see Output like the following (mary vary depending on GPU):</p>
<p><code>bash
   [Vector addition of 5000 elements]
   Copy input data from the host memory to the CUDA device
   CUDA kernel launch with 196 blocks of 256 threads
   Copy output data from the CUDA device to the host memory
   Test PASSED
   Done</code></p>
<ol>
<li>If successful, the pod can be deleted</li>
</ol>
<p><code>bash
   oc delete pod cuda-vector-add</code></p>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../ocm/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Openshift Cluster Manager (OCM)" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Openshift Cluster Manager (OCM)
            </div>
          </div>
        </a>
      
      
        
        <a href="../frontdoor/" class="md-footer__link md-footer__link--next" aria-label="Next: Azure Frontdoor" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Azure Frontdoor
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://khanhduy1407.github.io/docurial/" target="_blank" rel="noopener">
      Docurial
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky"], "search": "../../assets/javascripts/workers/search.22074ed6.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.960e086b.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
    
  </body>
</html>